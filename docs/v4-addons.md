
# Архитектурная надстройка JavaScript интерпретатора

Как было упомянуто на основной статье данного руководства программиста программного обеспечения, фреймворк расширяет функциональность JavaScript интерпретатора [V4](https://wiki.qt.io/V4). В этом документе будут расписаны доводы, послужившие катализатором выбора именно этого движка, а так же описание особенностей его публичного API и архитектуры дополнения.

## Критерии выбора JavaScript интерпретатора

В процессе выбора JavaScript интерпретатора были выделены следующие критерии:

 - Отсутствие вкроплений не C++ кода 

    Например, Objective-C. Это связано с основным требованием к данному программному обеспечению, выроженным максимальной переносимостью между операционными системами и [компиляторами](https://ru.stackoverflow.com/questions/1021524/Заголовочные-файлы-при-использовании-шаблонных-классов-c-с-компилятором-clang)

 - Возможность компиляции без развертки тяжелой системы сборки

    С ходом времени, все большее колличество C++ разработчиков отказываются от общепринятого способа размещения зависимостей проекта внутри поддиректории ["third party"](https://en.wikipedia.org/wiki/Third-party_software_component) в пользу применения тяжеловесных систем сборки проекта (например, [Bazel](https://bazel.build/)). В огромных программах это оправдано, но скачивать более 15 гигабайт хлама ради компиляции этого инструмента не рационально из-за розни с целями проекта.

    Как следствие, необходимо к разрешению:

    1. Не более 25-50 заголовочных файлов
        
        Вероятность совпадения имен объектных модулей при сборке.

    2. Потенциальная возможность переноса на QMake

        На текущий момент разворачивается тренд на применение утилиты CMake во всех C++ проектах глобально. В приоретете перенос на QMake в связи с безотказностью работы. 

 - Корпоративная поддержка

    Некоторые open source JavaScript интерпретаторы являются "toy project": поддержка ES6 выборочная, последний коммит в "2015". Это не серьезно.

## Выбор JavaScript интерпретатора. Анализ потенциальных движков

 - [Duktape](https://duktape.org/)

    Легковесный JavaScript интерпретатор без JIT для интеграции в существующее программное обеспечение в качестве движка скриптинга.

    #### Причина отказа:
    
    На момент августа 2019 частичная поддержка ES5 в синтаксисе [стрелочных функций](https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Functions/Arrow_functions). Случайный код работает некорректно при правильном синтаксисе. Фатальный недостаток.

 - [JavaScriptCore](https://github.com/WebKit/webkit/tree/master/Source/JavaScriptCore)

    Популярнейший JavaScript интерпритатор с JIT ускорением от Apple. Применяется везде: Nintendo Switch, Sony Playstation, iPhone Safary, Mac Safary и др. Рассматривалась версия интерпретатора, [совместимая с iOS 6](https://github.com/phoboslab/JavaScriptCore-iOS) как с самым слабым звеном. 

    #### Причина отказа:
    
    Отказ от поддержки данной версии последующими версиями iOS, вкропления кода Objective-C (Фатально)

 - [V8](https://v8.dev/)

    JavaScript интерпретатор, применяемый в Google Chrome и NodeJS

    #### Причина отказа:
    
    Отсутствие официального GitHub репозитория (неудобно качать). Полупроприетарная утилита для сборки проекта GN (["This is awesome! I've been waiting for a standalone GN for ages!!"](https://www.reddit.com/r/cpp/comments/90vabm/gn_a_metabuild_system_that_generates_build_files/)). Слишком сложно расширять и поддерживать на целевом множестве платформ при текущих финансовых ограничениях (фатально).

 - [JerryScript](https://github.com/jerryscript-project/jerryscript)

    Встраиваемый JavaScript интерпретатор от Samsung для устройств интернета вещей

    #### Причина отказа:
    
    Перемещение из-под крыла Samsung в обособленную open source организацию. Применение C99 в реализации (Фатально)

 - [KJS](https://github.com/KDE/kjs)

    JavaScript интерпретатор от разработчиков KDE. По ощущениям, это JavaScriptCore без Objective-C вкроплений в исходном коде и потенциально браузерно обвеса (например, WebAssembly). Примечательно, что исходный код реализован без библиотеки Qt и набор привязок поставляется [отдельно](https://github.com/KDE/kjsembed): потенциально большая масштабируемость.

    #### Причина отказа:
    
    Минусом данного решения является отсутствие обновлений с 2015 года. Мне неизвество, есть ли поддержка современных стандартов JavaScript. Было решено копать дальше.

 - [Hermes](https://github.com/facebook/hermes)

    Относительно новый (начало 2019) JavaScript интерпретатор от FaceBook,созданный с поправкой на React Native и мобильные операционные системы.

    #### Причина отказа:
    
    Слишком не спелый. Я не нашел публичного стабильного API прикладного программиста.

 - [V4](https://wiki.qt.io/V4)

    Встроенный в библиотеку Qt5 JavaScript интерпретатор с поддержкой ES6, JIT компиляцией и стабильным публичным API, выраженным абстракией (потенциально возможно переопределение с безболезненным переносом на другой движок, есть альтернативная реализация поверх V8). Это и послужило основной причиной выбора

    #### Недостатки:
    
    Отсутствие публичного API для [отладки](https://stackoverflow.com/questions/38064798/debugging-qjsengine) с момента появления в библиотеке. Сам движок реализует, но его API не публичное. В перспективе нужна реализация, оттолкнуться можно от родителя [QtScript](https://doc.qt.io/archives/qt-4.8/qscriptenginedebugger.html).

## Особенности публичного API движка V4

Библиотека Qt5 реализует публичное API поверх JavaScript интерпретатора V4. Оно выражено двумя классами: [QJSValue](https://doc.qt.io/qt-5/qjsvalue.html) и [QJSEngine](https://doc.qt.io/qt-5/qjsengine.html). Через первый мы можем манипулировать JavaScript значениями (вызвать функции, преобразовывать результат работы функций в C++ значение), через последний создавать функции или значения (передача аргументов в параметры) и вызывать сборщик мусора. Подразумевается, что в целях скриптинга приложение исполняет исключительно синхронный JavaScript код. Как следствие, цикл событий пришлось реализовать самостоятельно.